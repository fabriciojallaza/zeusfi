services:
  zeusfi_backend_wsgi:
    env_file:
      - dev.env
    build:
      context: ..
      dockerfile: backend/Dockerfile
    command: uvicorn core.asgi:application --host 0.0.0.0 --port 8000 --reload --reload-exclude tofu --reload-exclude .venv --reload-exclude openspec --reload-exclude knowledge --reload-exclude docs --reload-exclude .git --reload-exclude .claude
    ports:
      - "8000:8000"
    volumes:
      - .:/app:cached
      - /app/.venv
    develop:
      watch:
        - action: sync
          path: ..
          target: /app
          ignore:
            - .venv/
            - .git/
            - .claude/
            - tofu/
            - docs/
            - openspec/
            - knowledge/
            - .pytest_cache/
            - __pycache__/
            - '*.pyc'
            - .ruff_cache/
            - htmlcov/
            - .coverage
            - '*.log'

        - action: rebuild
          path: ./uv.lock
    restart: unless-stopped
    depends_on:
      - redis
    networks:
      - app-network

  redis:
    image: redis:latest
    container_name: fab-test-redis
    restart: unless-stopped
    networks:
      - app-network

  celery:
    env_file:
      - dev.env
    build:
      context: ..
      dockerfile: backend/Dockerfile
    entrypoint: "uv run celery -A core worker --loglevel=info --concurrency=4"
    volumes:
      - .:/app:cached
      - /app/.venv
    depends_on:
      - redis
    restart: unless-stopped
    networks:
      - app-network

volumes:
  celerybeat-schedule:

networks:
  app-network:
    driver: bridge